# install for virtual box

1. debianのイメージをダウンロードする。

1. Virtual Boxを立ち上げて、`新規`を押す。

1. 名前に`debian`と入力して、そのままでよければ、OKをクリックする。（マシンフォルダーに保存される。）ディスクサイズは８GBあればいけるはず。

1. 作成されたマシンイメージの設定をひらく。ストレージのCDのようなマークをクリックして、ダウンロードしたOSイメージを選択する。

1. 選択されたことを確認して、VMを起動

1. 今回は、`Install`を選択。言語、地域、キー配列を英語にする。＜＝インストール後のエラーログが文字化けしない。

1. ホスト名をユーザー名と接尾語として42をつけたものを設定する。

1. ドメイン名は無しでもいいと思われる。

1. ルートのパスワードは後で変更するためなんでも良いが予測されやすいものはよろしくない。

1. ユーザー名は`root`とは別に設定する。例：イントラ名

1. ユーザーのパスワードもなんでも良い。

1. 全ての領域を使う。後から変更する予定。

1. パーティショニング無し。後から変更する予定。

1. そのままインストールする。

1. 追加のメディアの検査って何？とりあえず、いいえ。

1. アーカイブミラーは`ftp.riken.jp`を選択。ドメインが、jpで、理研ってなんとなく良さそうだから。

1. 情報提出は無し。する必要ないと判断。

1. 追加のソフトウェアは何も無し。チェックを全て外す。

1. 多分GRUBブートローダーがないとOS起動しないので、インストール。場所は、手動以外のを選択。

1. 再起動するかどうか聞かれるので再起動する。

1. 完了

# LVM

> 参考：https://wiki.debian.org/LVM#Encrypted_LVM

1. 管理者権限で`apt install lvm2`を実行。

1.

# SSH Server

1. 管理者権限で`apt install openssh-server`を実行。

1. ポートを`4242`に絞るため、`/etc/ssh/sshd_config`ファイルを管理者権限で編集し、`Port 22`の部分を`Port 4242`に変更し保存する。（色々設定できるようである。）

1. 続けて、`DenyUsers root`ルールを作成して、rootでアクセスできないようにする。

1. ホストと通信するために、ネットワークをブリッジアダプターに変更する。（多分再起動必要）

1. （`systemctl restart ssh.service`でいけると思ったけど行けなかった。多分ネットワークの構成があってなかったから）

1. `ip address`でipv4のアドレスを確認する。

1. アクセスしたい場所から、`ssh -l login_name -p port -4 v4Address`のようなコマンド形式を使ってログインする。ログインできれば、構築完了。（いったん）

# sudo

> `visudo` 実行時に`vim`で起動したい場合は、`sudo update-alternatives --config editor`を実行して、`vim.tiny`を選択する。

1. 管理者権限で`apt install sudo`を実行。

1. もしも、ユーザー権限でログインした後`su`を実行して、`/etc/sudoers`を編集する際は、`-`オプションをつけて管理者権限用の環境変数に変更する。
もしくは、`root`でログインし直す。

1. `/etc/sudoers`を`visudo`コマンドを実行して、編集開始する。

## `sudo` コマンドを使った認証は３回まで行うことができます。

1. `Defaults	passwd_tries=3`を追加して、パスワードの認証回数を制限する。

## `sudo`を使って、パスワードを間違えた場合、選択したカスタムメッセージを表示すること？。

1. パスワードを間違えた時のメッセージをカスタマイズする。`Defaults	badpass_message="パスワードを間違えた時に表示したいメッセージ"`の行を追加して、保存する。

## `sudo`を使った全ての実行は、入力、出力ともに、`/var/log/sudo/` フォルダにアーカイブする必要がある。

1. `Defaults	log_input` を追加して、入力のロギングを有効にする。

1. `Defaults	log_output` を追加して、出力のロギングを有効にする。

1. `Defaults	logfile="/var/log/sudo/"` を追加して、出力されるログのパスを指定する。

## セキュリティの観点で、`TTY`モードは有効にする必要がある。

1. `Defaults	requiretty` を設定することで、ttyを必須にする。

## セキュリティの観点で、`/usr/local/sbin`, `/usr/local/bin`, `/usr/sbin`, `/usr/bin`, `/sbin`, `/bin`, `/snap/bin`
のようなパスは、`sudo`でも制限する必要がある。

1. `root`で`/usr/sudo-bin`ディレクトリを作成する。権限設定例`drwxr-xr-x` 所有者、所有グループが`root`であることを確認する。

1. `Defaults	secure_path="/usr/sudo-bin`を追加する。

1. 必要に応じて`root`権限で`ln`コマンドを使って、`/usr/sudo-bin`にコマンドを追加する。

> こうすることで、`sudo-bin`に入れたもの以外は`sudo`で実行できない。

# man

1. 管理者権限で`apt install man`を実行。

# グループの追加

1. 管理者権限で、`groupadd user42`を実行して、`user42`グループを追加する。

# password 要件

#### 30日ごとに有効期限が切れる必要があるよ。
#### パスワードを変更して良い最少日数は２日だよ。
#### 有効期限の７日前に警告が表示される必要があるよ。

1. `chage -m 2 -M 30 -W 7 root`, `chage -m 2 -M 30 -W 7 ユーザー名` を実行して、現在のユーザーの期限を設定する。

1. 今後、新規ユーザーが入った時にも自動で設定されるように、管理者権限で、`/etc/login.def`を修正開始する。

1. `PASS_MAX_DAYS`の値を`30`に修正する。

1. `PASS_MIN_DAYS`を`2`に修正する。

1. `PASS_WARN_AGE`を`7`に修正する。

> `passwd`コマンドでも設定可能のようである。

#### パスワードは少なくとも十文字以上である必要があるよ。
#### パスワードは、大文字と小文字、数値が含まれている必要があるよ。
#### ３つ以上連続した文字は含めれないよ。
#### パスワードはユーザー名を含んじゃいけないよ。
#### ユーザーのパスワードには、以前のパスワードにない7種類の文字が含まれている必要があるよ。
#### これらのパスワードポリシーにはrootも従う必要があるよ。


> `man pam.d`を参照してね。`required`のことや構文について書かれているよ。
> `man pam_unix`を参照してね。オプションについて書かれているよ。
> `man pma.d`にはモジュールの場所は、`/lib/security/`にあると書かれているけどないよ笑`/usr`の中を`pam_unix`という名前を含むファイルを探してね。

1. パスワードのルールを判定するために、`apt install -y libpam-pwquality`を実行してインストールする。（もしも、設定を上書きするかどうかを聞かれた時は、OKする）

1. `/etc/pam.d/common-password`ファイルを管理者権限で開いてね。

1. `password	requisite	pam_pwquality.so retry=3`の記載がある行を次のように編集する。
```
password	requisite	pam_pwquality.so retry=3 \
	minlen=10 dcredit=-1 ucredit=-1 lcredit=-1 maxrepeat=3 usercheck=1 diffok=7 enforce_for_root
```
> `dcredit=-1`: 数値が一文字以上含まれていること
> `ucredit=-1`: 大文字が一文字以上含まれていること
> `lcredit=-1`: 小文字が一文字以上含まれていること
> `maxrepeat=3`: 文字の繰り返しが最大で３回であること。
> `usercheck=1`: ログイン名が含まれていないこと。（ログイン名が三文字以下の場合は動作しない。）
> `diffok=7`: パスワードに対して、変更（挿入、削除、置換）して同じパスワードにならないこと。
> `enforce_for_root`: `root`ユーザにもパスワードポリシーを強制する。

# UFW ファイヤーウォール設定

1. 管理者権限で入った後に、`apt install ufw`を実行してインストールする。

## 4242 のポートだけ開く

1. 管理者権限で入った後、`ufw allow in 4242`を実行する。

1. `ufw enable` を実行して、ファイヤーウォールを起動する。

> ping を使うと応答が返ってくるが、これはポートと関係なく反応しているためである。

> ping も拒否したい場合は、別途ICMPを拒否するように設定する必要がある。

> ポートが開いていないことは、`nc`コマンドを使うことで確認できる。

> `nc -vz -G 1 -w 1 IPアドレス ポート番号` １秒タイムアウトで、ポートが開いているかどうかを確認できる。

### 情報

1. `monitoring.sh`を作成し、`root`のホームディレクトリに保存する。

1. `crontab -e -u root`を実行して、`cron`の設定ファイルを開く。

1. `*/10 * * * * bash ~/monitoring.sh`の行を追加して、保存し閉じる。

1. １０分後に情報が表示されればOK。
